<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b1a" />
  <title>×™×•× ×”×•×œ×“×ª ×©××— ×œ××¤×¨×ª</title>
  <style>
    :root{
      --bg:#0b0b1a; --bg2:#12122a; --fg:#f5f7ff;
      --accent:#ff58a6; --accent2:#7cf7ff; --gold:#ffd166; --success:#6ef3a5;
      --shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 50px rgba(255,255,255,.02);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family:system-ui,"IBM Plex Sans Hebrew","Segoe UI","Noto Sans Hebrew",sans-serif; color:var(--fg);
      background: radial-gradient(100vw 100svh at 110% -10%, #1e1140 0%, transparent 70%),
                  radial-gradient(80vw 70svh at -10% 120%, #061d3a 0%, transparent 70%),
                  linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
      overflow:hidden; -webkit-tap-highlight-color:transparent;}

    .screen{height:100svh; position:absolute; inset:0; opacity:0; pointer-events:none; transition:opacity .4s ease; visibility:hidden}
    .screen.show{opacity:1; pointer-events:auto; visibility:visible; z-index:10}

    /* TEASER */
    .teaser{z-index:20; display:flex; align-items:center; justify-content:center}
    .runaway-wrap{position:relative; width:min(640px, 92vw); height:62vh; border-radius:22px; border:1px solid rgba(255,255,255,.08); box-shadow:var(--shadow); overflow:hidden; background: linear-gradient(160deg, rgba(255,255,255,.04), rgba(255,255,255,.01));}
    .runaway-btn{position:absolute; inset:auto; translate:-50% -50%; top:50%; left:50%; padding:14px 18px; border-radius:999px; border:none; font-weight:800; letter-spacing:.3px; color:#10101a; background: linear-gradient(180deg, var(--accent) 0%, #ff2b7b 100%); box-shadow: 0 10px 20px rgba(255,43,123,.35), 0 0 0 2px rgba(255,255,255,.15) inset; outline-offset:4px; cursor:pointer; touch-action:manipulation; transition: transform .12s ease}
    .runaway-btn:active{transform:scale(.98)}
    .catch-message{position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:24px; font-weight:bold; color:var(--accent); text-shadow:0 0 10px var(--accent); opacity:0; transition:opacity .3s; pointer-events:none}
    .catch-message.show{opacity:1}

    /* FIREWORKS PRELUDE & CANVAS */
    #fireworks-canvas{position:fixed; left:0; top:0; width:100vw; height:100svh; pointer-events:none; z-index:1}

    /* PARTY */
    .party-inner{position:relative; z-index:5; height:100%; display:grid; grid-template-rows:auto auto auto 1fr; place-items:center; text-align:center; padding:calc(env(safe-area-inset-top) + 12px) 12px calc(env(safe-area-inset-bottom) + 12px);} 
    h1{font-size:clamp(26px, 6vw, 46px); line-height:1.1; margin:0 0 4px; letter-spacing:.2px; background:linear-gradient(90deg,var(--accent),var(--accent2)); -webkit-background-clip:text; background-clip:text; color:transparent; filter:drop-shadow(0 6px 16px rgba(0,0,0,.35)); animation:glow 4s ease-in-out infinite}
    @keyframes glow{0%{text-shadow:0 0 0 rgba(255,255,255,0)} 50%{text-shadow:0 0 20px rgba(255,255,255,.22)} 100%{text-shadow:0 0 0 rgba(255,255,255,0)}}
    .subtitle{opacity:.92; font-size:clamp(14px, 3.2vw, 18px); margin-bottom:6px}
    .greeting{max-width:820px; margin:2px auto 8px; line-height:1.6; opacity:.96; font-size:clamp(13px,3vw,17px)}

    /* CAKE */
    .cake-wrap{ position:relative; z-index:6; width:min(440px, 90vw); max-height:50svh; margin:6px auto 8px; filter: drop-shadow(0 14px 34px rgba(0,0,0,.55)); display:block; opacity:0; visibility:hidden}
    .cake-wrap.show{opacity:1; visibility:visible}

    /* CAKE ANIMS */
    .fade-in-up{animation:fade-in-up .6s ease-out backwards}.zoom-in{animation:zoom-in .5s ease-out backwards}.spin-in{animation:spin-in .7s cubic-bezier(.175,.885,.32,1.275) backwards}.drop-in{animation:drop-in .6s cubic-bezier(.7,0,.3,1) backwards}.blur-in{animation:blur-in .5s ease-out backwards}.flip-in{animation:flip-in .7s ease-out backwards}.slide-in-left{animation:slide-in-left .6s ease-out backwards}.slide-in-right{animation:slide-in-right .6s ease-out backwards}.bounce-in{animation:bounce-in .7s cubic-bezier(.68,-.55,.27,1.55) backwards}.roll-in{animation:roll-in .8s ease-out backwards}.swing-in{animation:swing-in .8s ease-out backwards}
    @keyframes fade-in-up{from{opacity:0;transform:translateY(30px) scale(.98)}}
    @keyframes zoom-in{from{opacity:0;transform:scale(.8)}}
    @keyframes spin-in{from{opacity:0;transform:rotate(-90deg) scale(.7)}}
    @keyframes drop-in{from{opacity:0;transform:translateY(-80px) scale(1.1)}}
    @keyframes blur-in{from{opacity:0;filter:blur(10px)}}
    @keyframes flip-in{from{opacity:0;transform:perspective(1000px) rotateX(-90deg)}}
    @keyframes slide-in-left{from{opacity:0;transform:translateX(-100px)}}
    @keyframes slide-in-right{from{opacity:0;transform:translateX(100px)}}
    @keyframes bounce-in{from{opacity:0;transform:scale(0.5)}}
    @keyframes roll-in{from{opacity:0;transform:translateX(-100%) rotate(-120deg)}}
    @keyframes swing-in{from{opacity:0;transform:perspective(500px) rotateY(-90deg)}}

    /* BALLOONS */
    .balloons{ position:fixed; bottom:-25vh; left:0; width:100vw; height:140vh; pointer-events:none; overflow:visible; z-index:2 }
    .balloon{ position:absolute; bottom:-20vh; width:var(--w,34px); height:calc(var(--w,34px)*1.35); transform-origin:center bottom; will-change:transform; animation: sway var(--swayDur,3.8s) ease-in-out infinite }
    .b-body{ position:absolute; inset:0; border-radius:50% 50% 46% 54% / 62% 62% 38% 38%; background:
        radial-gradient(120% 120% at 25% 30%, rgba(255,255,255,.85) 0%, rgba(255,255,255,.35) 8%, rgba(255,255,255,0) 30%),
        radial-gradient(120% 120% at 70% 80%, rgba(0,0,0,.25) 0%, rgba(0,0,0,0) 60%), var(--balloonColor,#ff6b6b);
      box-shadow: inset 0 -10px 18px rgba(0,0,0,.22), 0 12px 20px rgba(0,0,0,.28); transform: translateY(0); animation: rise var(--riseDur,10s) linear forwards }
    .b-knot{ position:absolute; bottom:-4px; left:50%; width:10px; height:8px; background:rgba(0,0,0,.15); transform:translateX(-50%) rotate(15deg); clip-path: polygon(50% 0, 100% 100%, 0 100%); filter:brightness(1.2) }
    .b-string{ position:absolute; bottom:-24px; left:50%; width:2px; height:var(--stringH,34px); background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.2)); transform:translateX(-50%); border-radius:2px; opacity:.85; animation: stringWiggle var(--swayDur,3.8s) ease-in-out infinite; transform-origin: top center }
    @keyframes rise{0%{transform:translateY(0) scale(1);opacity:1}85%{transform:translateY(-110vh) scale(1.02);opacity:1}100%{transform:translateY(-140vh) scale(1.03);opacity:0}}
    @keyframes sway{0%,100%{transform:translateX(calc(var(--amp,14px)*-1))}50%{transform:translateX(var(--amp,14px))}}
    @keyframes stringWiggle{0%,100%{transform:translateX(-50%) rotate(-4deg)}50%{transform:translateX(-50%) rotate(4deg)}}

    /* CTA & FOOTER */
    .btn-corner{
      position: fixed;
      top: calc(env(safe-area-inset-top) + 16px);
      right: 16px;
      z-index: 99;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      -webkit-backdrop-filter: blur(5px);
      backdrop-filter: blur(5px);
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 700;
      cursor: pointer;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .party.show .btn-corner {
      opacity: 1;
      visibility: visible;
    }
    footer{position:fixed; bottom:6px; left:0; right:0; text-align:center; font-size:11px; opacity:.5}

    @media (max-height:640px){
      h1{font-size:clamp(22px,5vw,38px)}
      .cake-wrap{width:min(420px,92vw); max-height:46svh}
    }
    @media (prefers-reduced-motion:reduce){ .runaway-btn, .balloon, .b-body{transition:none; animation:none} }
  </style>
</head>
<body>
  <canvas id="fireworks-canvas"></canvas>

  <!-- TEASER -->
  <section class="screen teaser show" id="teaser">
    <div class="runaway-wrap" id="arena">
      <button class="runaway-btn" id="btn">×ª×œ×—×¦×™ ×¢×œ×™×™</button>
      <div id="catch-message" class="catch-message">×œ× ×ª×ª×¤×¡×™ ××•×ª×™!</div>
    </div>
  </section>

  <!-- FIREWORKS PRELUDE -->
  <section class="screen fireworks-prelude" id="fireworks-prelude"></section>

  <!-- PARTY -->
  <section class="screen party" id="party">
    <button class="btn-corner" id="replay">×”×ª×—×œ×” ××—×“×©</button>
    <div class="balloons" id="balloons" aria-hidden="true"></div>

    <div class="party-inner">
      <h1 id="title"></h1>
      <div class="subtitle" id="subtitle"></div>
      <p class="greeting" id="greeting"></p>

      <div class="cake-wrap" id="cake" aria-hidden="true">
        <!-- New SVG Cake -->
        <svg viewBox="0 0 500 450" width="100%" role="img" aria-label="×¢×•×’×ª ×™×•× ×”×•×œ×“×ª ××¤×•××¨×ª ×•××¦×™××•×ª×™×ª">
            <defs>
                <!-- Filters & Gradients -->
                <filter id="soft-shadow" x="-50%" y="-50%" width="200%" height="200%">
                    <feDropShadow dx="0" dy="12" stdDeviation="10" flood-color="#000000" flood-opacity="0.35"/>
                </filter>
                <filter id="flame-glow" x="-50%" y="-50%" width="200%" height="200%">
                    <feGaussianBlur in="SourceGraphic" stdDeviation="3.5" result="blur"/>
                    <feMerge>
                        <feMergeNode in="blur"/>
                        <feMergeNode in="SourceGraphic"/>
                    </feMerge>
                </filter>
                <radialGradient id="plate-grad" cx="50%" cy="50%" r="65%">
                    <stop offset="0%" stop-color="#ffffff"/>
                    <stop offset="85%" stop-color="#f2f2f2"/>
                    <stop offset="100%" stop-color="#e8e8e8"/>
                </radialGradient>
                <linearGradient id="bottom-tier-grad" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="#ffe8f0"/>
                    <stop offset="100%" stop-color="#ffd1e3"/>
                </linearGradient>
                <linearGradient id="top-tier-grad" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="#fef9e7"/>
                    <stop offset="100%" stop-color="#fdedc1"/>
                </linearGradient>
                <linearGradient id="drip-grad" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="0%" stop-color="#ffffff" stop-opacity="0.9"/>
                    <stop offset="100%" stop-color="#ffffff" stop-opacity="0.6"/>
                </linearGradient>
                <radialGradient id="flame-outer" cx="50%" cy="60%" r="50%">
                    <stop offset="0%" stop-color="#fff5b3" stop-opacity="0.8"/>
                    <stop offset="70%" stop-color="#ffb347" stop-opacity="0.7"/>
                    <stop offset="100%" stop-color="#ff7f50" stop-opacity="0.3"/>
                </radialGradient>
                <radialGradient id="flame-inner" cx="50%" cy="70%" r="50%">
                    <stop offset="0%" stop-color="#ffffff"/>
                    <stop offset="100%" stop-color="#ffe27a"/>
                </radialGradient>
            </defs>
        
            <g filter="url(#soft-shadow)">
                <!-- Plate -->
                <ellipse cx="250" cy="415" rx="220" ry="25" fill="#c0c0c0" opacity="0.5"/>
                <ellipse cx="250" cy="410" rx="220" ry="25" fill="url(#plate-grad)" stroke="#d8d8d8"/>
        
                <!-- Bottom Tier -->
                <g id="bottom-tier">
                    <rect x="80" y="270" width="340" height="120" rx="20" fill="url(#bottom-tier-grad)"/>
                    <ellipse cx="250" cy="270" rx="170" ry="40" fill="#fff0f5" stroke="#ffdbe9" stroke-width="1.5"/>
                    <!-- Drips -->
                    <path d="M80,280 C100,320 130,280 150,300 C170,320 190,290 210,305 C230,320 250,295 270,305 C290,315 310,290 330,300 C350,310 370,285 390,295 C400,300 410,280 420,280" fill="url(#drip-grad)" stroke="#ffffff" stroke-width="0.5"/>
                </g>
                
                <!-- Top Tier -->
                <g id="top-tier">
                    <rect x="130" y="170" width="240" height="100" rx="15" fill="url(#top-tier-grad)"/>
                    <ellipse cx="250" cy="170" rx="120" ry="35" fill="#fffcf2" stroke="#fcf3cf" stroke-width="1.5"/>
                    <!-- Drips -->
                    <path d="M130,180 C150,210 170,180 190,195 C210,210 230,185 250,190 C270,195 290,180 310,195 C330,210 350,180 370,180" fill="url(#drip-grad)" stroke="#ffffff" stroke-width="0.5"/>
                </g>
        
                <!-- Decorations -->
                <g id="decorations">
                    <!-- Piped frosting on top tier -->
                    <circle cx="250" cy="155" r="14" fill="#ff85b3"/> <circle cx="250" cy="155" r="5" fill="#fff"/>
                    <circle cx="200" cy="160" r="12" fill="#ff85b3"/> <circle cx="200" cy="160" r="4" fill="#fff"/>
                    <circle cx="300" cy="160" r="12" fill="#ff85b3"/> <circle cx="300" cy="160" r="4" fill="#fff"/>
                    <!-- Piped frosting on bottom tier -->
                    <circle cx="250" cy="255" r="18" fill="#ff85b3"/> <circle cx="250" cy="255" r="7" fill="#fff"/>
                    <circle cx="180" cy="260" r="16" fill="#ff85b3"/> <circle cx="180" cy="260" r="6" fill="#fff"/>
                    <circle cx="320" cy="260" r="16" fill="#ff85b3"/> <circle cx="320" cy="260" r="6" fill="#fff"/>
                    <circle cx="120" cy="265" r="14" fill="#ff85b3"/> <circle cx="120" cy="265" r="5" fill="#fff"/>
                    <circle cx="380" cy="265" r="14" fill="#ff85b3"/> <circle cx="380" cy="265" r="5" fill="#fff"/>
                </g>
        
                <!-- Candles -->
                <g id="candles" filter="url(#flame-glow)">
                    <g transform="translate(220, 110)">
                        <rect x="-4" y="0" width="8" height="45" rx="3" fill="#ffca7a"/>
                        <ellipse cx="0" cy="-5" rx="6" ry="8" fill="url(#flame-outer)">
                            <animate attributeName="ry" values="8;7;8" dur="0.8s" repeatCount="indefinite"/>
                        </ellipse>
                        <ellipse cx="0" cy="-5" rx="3" ry="5" fill="url(#flame-inner)">
                            <animate attributeName="ry" values="5;4;5" dur="0.8s" repeatCount="indefinite"/>
                        </ellipse>
                    </g>
                    <g transform="translate(250, 100)">
                        <rect x="-4" y="0" width="8" height="55" rx="3" fill="#a9d1ff"/>
                        <ellipse cx="0" cy="-5" rx="6.5" ry="8.5" fill="url(#flame-outer)">
                            <animate attributeName="ry" values="8.5;7.5;8.5" dur="0.9s" repeatCount="indefinite"/>
                        </ellipse>
                        <ellipse cx="0" cy="-5" rx="3.5" ry="5.5" fill="url(#flame-inner)">
                            <animate attributeName="ry" values="5.5;4.5;5.5" dur="0.9s" repeatCount="indefinite"/>
                        </ellipse>
                    </g>
                    <g transform="translate(280, 110)">
                        <rect x="-4" y="0" width="8" height="45" rx="3" fill="#ffca7a"/>
                        <ellipse cx="0" cy="-5" rx="6" ry="8" fill="url(#flame-outer)">
                            <animate attributeName="ry" values="8;7.2;8" dur="0.7s" repeatCount="indefinite"/>
                        </ellipse>
                        <ellipse cx="0" cy="-5" rx="3" ry="5" fill="url(#flame-inner)">
                            <animate attributeName="ry" values="5;4.2;5" dur="0.7s" repeatCount="indefinite"/>
                        </ellipse>
                    </g>
                </g>
                
                <!-- Text on cake -->
                <text x="250" y="325" text-anchor="middle" font-size="32" font-weight="bold" fill="#c73f75" font-family="system-ui, 'IBM Plex Sans Hebrew', 'Noto Sans Hebrew', sans-serif" stroke="#fff" stroke-width="1.5" paint-order="stroke">
                    <tspan x="250">××–×œ ×˜×•×‘</tspan>
                    <tspan x="250" dy="1.2em" font-size="42" id="cake-name">××¤×¨×ª</tspan>
                </text>
            </g>
        </svg>
      </div>
    </div>
    <footer>× ×‘× ×” ×‘××”×‘×” ×¢"×™ × ×“×‘ âœ¨</footer>
  </section>

  <script>
  (function(){
    const $ = sel => document.querySelector(sel);
    const teaser = $('#teaser');
    const prelude = $('#fireworks-prelude');
    const party = $('#party');
    const btn = $('#btn');
    const arena = $('#arena');
    const catchMessage = $('#catch-message');

    // Text Content
    const url = new URL(window.location.href);
    const birthdayName = decodeURIComponent(url.searchParams.get('name') || '××¤×¨×ª');
    $('#title').textContent = `×™×•× ×”×•×œ×“×ª ×©××— ×œ${birthdayName}!`;
    $('#subtitle').textContent = '×‘×œ×•× ×™×, ×–×™×§×•×§×™× ×•×”××•×Ÿ ×”×¤×ª×¢×•×ª â€“ ×›×™ ××’×™×¢ ×œ×š ×œ×—×’×•×’ ×‘×’×“×•×œ! ğŸˆ';
    $('#greeting').innerHTML = `${birthdayName}, ×©×ª×”×™×” ×©× ×” ××œ××” ×‘×¨×™××•×ª, ×¦×—×•×§ ×•×”×’×©××”, ×¢× ×¨×’×¢×™× ××¤×ª×™×¢×™× ×©×××œ××™× ××ª ×”×œ×‘.<br>××™×›××œ ×œ×¦×“×š ×•×ª×•××¨ ×©××•×¡×™×£ ×›×œ ×›×š ×”×¨×‘×” ×©××—×” â€“ ×©×”×‘×™×ª ×™××©×™×š ×œ×”×™×•×ª ××œ× ××•×¨ ×•×× ×¨×’×™×•×ª ×˜×•×‘×•×ª.<br><strong>×××—×œ, × ×“×‘</strong>.`;
    $('#cake-name').textContent = birthdayName;

    // State
    const messages = ['×œ× ×”×¦×œ×—×ª', '××•×¤×¡ ×›××¢×˜', '× ×¡×™ ×©×•×‘', '×œ× ×ª×ª×¤×¡×™ ××•×ª×™'];
    let attempts = 0;
    let cakeShown = false;
    let preludeTimeout = null;
    let cakeRect = null;

    function placeButtonRandom() {
      const rect = arena.getBoundingClientRect();
      const br = btn.getBoundingClientRect();
      const padX = rect.width * 0.12; const padY = rect.height * 0.12;
      const x = Math.random() * (rect.width - br.width - padX * 2) + padX;
      const y = Math.random() * (rect.height - br.height - padY * 2) + padY;
      btn.style.left = x + 'px';
      btn.style.top = y + 'px';
      btn.style.translate = '0 0';
    }

    btn.addEventListener('click', (ev) => {
      ev.preventDefault();
      attempts++;
      btn.textContent = messages[Math.min(attempts - 1, messages.length - 1)];

      if (attempts >= 4) {
        btn.style.display = 'none';
        catchMessage.classList.add('show');
        setTimeout(() => {
          teaser.classList.remove('show');
          catchMessage.classList.remove('show');
          prelude.classList.add('show');
          startPreludeFireworks();
          
          preludeTimeout = setTimeout(revealParty, 5000);
          
          const endPrelude = () => {
            clearTimeout(preludeTimeout);
            revealParty();
            prelude.removeEventListener('click', endPrelude);
            prelude.removeEventListener('pointerdown', endPrelude);
          };
          
          prelude.addEventListener('click', endPrelude, { once: true });
          prelude.addEventListener('pointerdown', endPrelude, { once: true });
        }, 800);
      } else {
        placeButtonRandom();
        if (navigator.vibrate) try { navigator.vibrate(12); } catch {}
      }
    });

    // ==== PARTY REVEAL
    function revealParty() {
      if (party.classList.contains('show')) return;
      stopPreludeFireworks();
      prelude.classList.remove('show');
      party.classList.add('show');
      
      requestAnimationFrame(() => {
        cakeRect = $('#cake').getBoundingClientRect();
        setTimeout(() => {
          showCake();
          startBalloons();
          startFountainFireworks();
        }, 300);
      });
    }
    
    const cakeAnims = ['fade-in-up', 'zoom-in', 'spin-in', 'drop-in', 'blur-in', 'flip-in', 'slide-in-left', 'slide-in-right', 'bounce-in', 'roll-in', 'swing-in'];
    function showCake() {
      const cake = $('#cake');
      cake.className = 'cake-wrap'; // Reset classes
      const randomAnim = cakeAnims[Math.floor(Math.random() * cakeAnims.length)];
      void cake.offsetWidth; // Trigger reflow
      cake.classList.add(randomAnim, 'show');
      cakeShown = true;
    }
    function hideCake() {
        const cake = $('#cake');
        cake.className = 'cake-wrap';
        cakeShown = false;
    }

    // ==== BALLOONS
    const balloonsRoot = $('#balloons');
    const balColors = ['#ff6b6b','#ffd166','#6ef3a5','#7cf7ff','#c38cff','#ff9bd0'];
    let balloonInterval;
    function spawnBalloon() {
        const wrap = document.createElement('div'); wrap.className = 'balloon';
        const size = 26 + Math.random()*18, rise = 9 + Math.random()*9, sway = 3 + Math.random()*2.8, amp = 12 + Math.random()*18, stringH = 24 + Math.random()*28; const color = balColors[Math.floor(Math.random()*balColors.length)];
        wrap.style.setProperty('--w', size+'px'); wrap.style.setProperty('--riseDur', rise+'s'); wrap.style.setProperty('--swayDur', sway+'s'); wrap.style.setProperty('--amp', amp+'px'); wrap.style.setProperty('--stringH', stringH+'px'); wrap.style.left = Math.random()*100 + 'vw';
        const body = document.createElement('div'); body.className = 'b-body'; body.style.setProperty('--balloonColor', color);
        const knot = document.createElement('div'); knot.className = 'b-knot'; const str = document.createElement('span'); str.className = 'b-string';
        wrap.appendChild(body); wrap.appendChild(knot); wrap.appendChild(str); balloonsRoot.appendChild(wrap);
        body.addEventListener('animationend', ()=>{ wrap.remove(); }, {once:true});
    }
    function startBalloons() {
        if (balloonInterval) clearInterval(balloonInterval);
        for (let i=0; i<15; i++) setTimeout(spawnBalloon, i * 150);
        balloonInterval = setInterval(spawnBalloon, 300);
    }
    function stopBalloons() {
        if (balloonInterval) clearInterval(balloonInterval);
        balloonsRoot.innerHTML = '';
    }

    // ==== FIREWORKS
    const fwCanvas = document.getElementById('fireworks-canvas');
    const ctx = fwCanvas.getContext('2d');
    let dpr = 1, viewportW = 0, viewportH = 0;
    const particles = [];
    
    function resizeCanvas() {
        viewportW = window.innerWidth;
        viewportH = window.innerHeight;
        dpr = window.devicePixelRatio || 1;
        fwCanvas.width = viewportW * dpr;
        fwCanvas.height = viewportH * dpr;
        fwCanvas.style.width = viewportW + 'px';
        fwCanvas.style.height = viewportH + 'px';
        ctx.scale(dpr, dpr);
        if (party.classList.contains('show')) {
          cakeRect = $('#cake').getBoundingClientRect();
        }
    }
    window.addEventListener('resize', resizeCanvas, { passive: true });
    resizeCanvas();

    // --- Prelude Fireworks ---
    let preludeRunning = false, preludeInterval;
    const Patterns = {
      ring(n=100, s=2.3){ const a=[]; for(let i=0;i<n;i++){ const t=i/n*2*Math.PI; a.push([Math.cos(t)*s, Math.sin(t)*s]); } return a; },
      heart(n=140){ const a=[]; for(let i=0;i<n;i++){ const t=i/n*2*Math.PI; const x=16*Math.sin(t)**3, y=-(13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t)); const s=0.13; a.push([x*s, y*s]); } return a; },
      star(points=5, n=140){ const a=[]; const inner=1.1, outer=2.5; for(let i=0;i<n;i++){ const f=i/n; const seg=(Math.floor(f*points)%points); const ang=(seg/points)*2*Math.PI + (f*points%1)*2*Math.PI/points; const r=((f*points%1)<0.5?outer:inner); a.push([Math.cos(ang)*r, Math.sin(ang)*r]); } return a; },
      spiralCW(n=150){ const a=[]; for(let i=0;i<n;i++){ const t=i/n*6*Math.PI; const s=0.6+i/n*2.8; a.push([Math.cos(t)*s, Math.sin(t)*s]); } return a; },
      crossette(n=40){ const a=[]; for(let i=0;i<n;i++){ const t=i/n*2*Math.PI; const s=2.2; a.push([Math.cos(t)*s, Math.sin(t)*s, 'cros']); } return a; }
    };
    const patternList = ['ring', 'ring', 'heart', 'star', 'spiralCW', 'crossette'];

    function launchPreludeRocket() {
        const x = viewportW * (0.3 + Math.random() * 0.4);
        const y = viewportH;
        const targetY = viewportH * (0.2 + Math.random() * 0.3);
        const hue = Math.random() * 360;
        const rocket = {type: 'prelude', x, y, targetY, hue, path: [{x, y}], life: 200, vx: (Math.random()-0.5)*0.5, vy: -(4 + Math.random()*2)};
        particles.push(rocket);
    }
    function startPreludeFireworks() {
        if (preludeRunning || (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches)) return;
        preludeRunning = true;
        preludeInterval = setInterval(launchPreludeRocket, 450);
        if (!rafId) loop();
    }
    function stopPreludeFireworks() {
        preludeRunning = false;
        if (preludeInterval) clearInterval(preludeInterval);
    }

    // --- Fountain Fireworks ---
    let fountainRunning = false, fountainInterval;
    function launchFountainParticle() {
        if (!cakeRect) return;
        
        const x = cakeRect.left + cakeRect.width / 2;
        const y = cakeRect.top + cakeRect.height * 0.95;

        const isLeft = Math.random() > 0.5;
        const angle = isLeft
            ? -Math.PI * (0.6 + Math.random() * 0.3)  // -162deg to -108deg
            : -Math.PI * (0.1 + Math.random() * 0.3); // -72deg to -18deg

        const speed = 4 + Math.random() * 3;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;
        const hue = 200 + Math.random() * 160;
        const life = 120;
        particles.push({type: 'fountain', x, y, vx, vy, hue, life, alpha: 1, exploded: false});
    }
    function startFountainFireworks() {
        if (fountainRunning || (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches)) return;
        fountainRunning = true;
        fountainInterval = setInterval(launchFountainParticle, 35);
        if (!rafId) loop();
    }
    function stopFountainFireworks() {
        fountainRunning = false;
        if (fountainInterval) clearInterval(fountainInterval);
    }

    // --- Unified Animation Loop ---
    let rafId = null;
    function loop() {
        ctx.globalCompositeOperation = 'source-over';
        ctx.fillStyle = 'rgba(11, 11, 26, 0.2)';
        ctx.fillRect(0, 0, viewportW, viewportH);
        ctx.globalCompositeOperation = 'lighter';
        
        for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.life--;
            if (p.life <= 0) { particles.splice(i, 1); continue; }
            
            if (p.type === 'prelude') {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.03; // gravity against rocket
                p.path.push({x: p.x, y: p.y});
                if (p.path.length > 5) p.path.shift();
                if (p.vy >= 0) { // Explode at apex
                    explodePrelude(p.x, p.y, p.hue);
                    p.life = 0;
                }
            } else if (p.type === 'fountain') {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.08;
                p.alpha *= 0.99;
                if (p.vy > 0.5 && !p.exploded) {
                    explodeFountain(p.x, p.y, p.hue, 50, 0.8);
                    p.exploded = true;
                    p.life = 0;
                }
            } else if (p.type === 'explosion') {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.05;
                p.alpha *= 0.975;
                if (p.tag === 'cros' && p.life < p.splitAt) {
                    for (let k = 0; k < 4; k++) {
                        const ang = k * Math.PI / 2 + (Math.random() - 0.5) * 0.4;
                        const sp = 1.6;
                        particles.push({type: 'explosion', x: p.x, y: p.y, vx: Math.cos(ang) * sp, vy: Math.sin(ang) * sp, life: 28, alpha: 0.95, hue: p.hue, size: p.size * 0.9});
                    }
                    p.life = 0; // Kill original
                }
            }

            // Draw
            ctx.beginPath();
            ctx.fillStyle = `hsla(${p.hue}, 100%, 75%, ${p.alpha || 1})`;
            if (p.type === 'prelude') {
                const lastPoint = p.path[p.path.length-1];
                if (lastPoint) ctx.arc(lastPoint.x, lastPoint.y, 1.5, 0, Math.PI*2);
            } else if (p.type === 'fountain' && !p.exploded) {
                ctx.arc(p.x, p.y, 1.5, 0, Math.PI * 2);
            }
             else if (p.type === 'explosion') {
                ctx.arc(p.x, p.y, p.size || 1.5, 0, Math.PI * 2);
            }
            ctx.fill();
        }
        
        if (particles.length > 0 || fountainRunning || preludeRunning) {
            rafId = requestAnimationFrame(loop);
        } else {
            ctx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
            rafId = null;
        }
    }
    
    function explodePrelude(x, y, hue) {
      const name = patternList[Math.floor(Math.random() * patternList.length)];
      const base = Patterns[name]();
      const count = base.length;
      const sweep = Math.random() < 0.6 ? 20 + Math.random() * 70 : 0;
      
      for (let i = 0; i < count; i++) {
        const [vx, vy, tag] = base[i];
        const life = 60 + (Math.random() * 30 | 0);
        const size = 1.2 + Math.random() * 0.8;
        particles.push({
          type: 'explosion',
          x, y, vx, vy,
          life,
          alpha: 1,
          hue: (hue + (i / count) * sweep + (Math.random() * 18 - 9)) % 360,
          size,
          tag,
          splitAt: tag === 'cros' ? 40 : 0
        });
      }
    }
    
    function explodeFountain(x, y, hue, count = 100, speedFactor = 1.0) {
        for (let i = 0; i < count; i++) {
            const angle = Math.random() * Math.PI * 2;
            const speed = (2 + Math.random() * 3) * speedFactor;
            const vx = Math.cos(angle) * speed;
            const vy = Math.sin(angle) * speed;
            const life = 50 + Math.random() * 30;
            particles.push({type: 'explosion', x, y, vx, vy, hue: (hue + Math.random()*30 - 15)%360, life, alpha: 1});
        }
    }

    function stopAllFireworks() {
        stopPreludeFireworks();
        stopFountainFireworks();
        particles.length = 0;
    }

    // ==== App Initialization & Replay ====
    function init() {
        stopAllFireworks();
        stopBalloons();
        
        party.classList.remove('show');
        prelude.classList.remove('show');
        teaser.classList.add('show');
        
        attempts = 0;
        btn.textContent = '×ª×œ×—×¦×™ ×¢×œ×™×™';
        btn.style.display = 'inline-block';
        btn.style.left = '50%';
        btn.style.top = '50%';
        btn.style.translate = '-50% -50%';
        
        if (preludeTimeout) clearTimeout(preludeTimeout);
        hideCake();
    }
    
    $('#replay').addEventListener('click', init);

    // Start the app
    init();

  })();
  </script>
</body>
</html>